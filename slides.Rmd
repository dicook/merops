---
title: "Spatio-temporal effects in drug sales, <br>in association with demographics, provider, drugs choices and disease"
author: "Team MEROPS (bee-eaters) <br>Monash Experts in R, Organising Pharmaceutical Sales"
date: "<br>Members: Paul Harrison, Earo Wang, <br> Nat Tomasetti, Di Cook, Stuart Lee"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: ["default", "my-theme.css"]
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---


```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
library(knitr)
opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  error = FALSE,
  cache = TRUE,
  fig.height = 2,
  fig.width = 5,
  collapse = TRUE,
  comment = "#>"
)
```

```{r libraries, cache=FALSE}
library(zoo)
library(RSQLite)
library(forcats)
library(tidyverse)
library(lubridate)
library(gridExtra)
library(ggthemes)
library(ggmap)
```

```{r read_data, eval=FALSE}
# Read data and make summary files once only
db <- src_sqlite("MelbDatathon2017.sqlite", create = FALSE)
trans <- tbl(db, "Transactions")
drugs <- tbl(db, "Drugs") %>% collect(n = Inf)
illness_db <- tbl(db, "ChronicIllness")
patients_db <- tbl(db, "Patients")
stores <- tbl(db, "Stores") %>% collect(n = Inf)
  
dispense <- trans %>% 
  group_by(Dispense_Week) %>% 
  summarise(n = count()) %>% 
  collect(n = Inf)
save(dispense, file="data/dispense.rda")

illness <- illness_db %>% collect(n = Inf)
illness <- illness %>% mutate(MasterProductID = as.integer(MasterProductID))
chronic_drugs <- illness$MasterProductID
dispense_bychronic <- trans %>% 
  mutate(Chronic = if_else(Drug_ID %in% chronic_drugs, "Y", "N")) %>% 
  group_by(Chronic, Dispense_Week) %>% 
  tally() %>% 
  collect(n = Inf)
save(dispense_bychronic, file="data/dispense_bychronic.rda")

dispense_chronic_dat <- trans %>% 
  filter(Drug_ID %in% chronic_drugs) %>% 
  collect(n = Inf)
# By different chronic illness
dispense_chronic <- dispense_chronic_dat %>% 
  left_join(illness, by = c("Drug_ID" = "MasterProductID")) %>% 
  group_by(ChronicIllness, Dispense_Week) %>% 
  tally() %>% 
  mutate(
    Dispense_Week = as_date(Dispense_Week),
    Dispense_Year = year(Dispense_Week),
    Dispense_Month = month(Dispense_Week, label = TRUE),
    Dispense_Qtr = quarter(Dispense_Week)
  ) %>% 
  filter(Dispense_Year >= 2011, Dispense_Year < 2016)
save(dispense_chronic, file="data/dispense_chronic.rda")

patients <- tbl(db, 'Patients') %>% collect(n = Inf)
colnames(patients) <- c('Patient_ID', 'gender', 'year_of_birth', 'postcode')
patients$Patient_ID <- as.numeric(patients$Patient_ID)
tpatients <- ts %>% group_by(Patient_ID) %>% summarise(purchases=n(), totalSpend=sum(PatientPrice_Amt)) %>% collect()
highspend <- filter(tpatients, totalSpend > 20000)
hightrans <- ts %>% filter(Patient_ID %in% highspend$Patient_ID) %>% collect()

pt_524998 <- trans %>% 
  filter(Patient_ID == "524998") %>% collect()
colnames(patients)[1] <- "Patient_ID"
pt_524998_dem <- patients %>% 
  filter(Patient_ID == "524998") 
colnames(stores)[1] <- "Store_ID"
pt_524998_store <- stores %>% 
  filter(Store_ID == pt_524998$Store_ID[1])
pt_524998_dem$Patient_ID <-
  as.integer(pt_524998_dem$Patient_ID)
pt_524998_store$Store_ID <-
  as.integer(pt_524998_store$Store_ID)
pt_524998 <- left_join(pt_524998, pt_524998_dem) %>%
  rename(postcode_patient = postcode)
pt_524998 <- left_join(pt_524998, pt_524998_store)
save(pt_524998, file="data/patient_524988.rda")
```

```{r preprocess_data}
load("data/dispense.rda")
load("data/dispense_bychronic.rda")
load("data/dispense_chronic.rda")

dispense <- dispense %>% 
  mutate(
    Dispense_Week = as_date(Dispense_Week),
    Dispense_Year = year(Dispense_Week),
    Dispense_Month = month(Dispense_Week, label = TRUE),
    Dispense_Qtr = quarter(Dispense_Week)
  ) %>% 
  filter(Dispense_Year >= 2011, Dispense_Year < 2016)

dispense_qtr <- dispense %>% 
  filter(Dispense_Year >= 2011, Dispense_Year < 2016) %>% 
  group_by(Dispense_Year, Dispense_Qtr) %>% 
  summarise(trans_count = sum(n, na.rm = TRUE)) %>% 
  mutate(Dispense_YrQtr = as.yearqtr(
    paste(Dispense_Year, Dispense_Qtr, sep = " Q"), "%Y Q%q")
  )

# By chronic illness or not
dispense_bychronic <- dispense_bychronic %>% 
  mutate(
    Dispense_Week = as_date(Dispense_Week),
    Dispense_Year = year(Dispense_Week),
    Dispense_Month = month(Dispense_Week, label = TRUE),
    Dispense_Qtr = quarter(Dispense_Week)
  ) %>% 
  filter(Dispense_Year >= 2011, Dispense_Year < 2016)

dispense_bychronic_qtr <- dispense_bychronic %>% 
  group_by(Chronic, Dispense_Year, Dispense_Qtr) %>% 
  summarise(trans_count = sum(n, na.rm = TRUE)) %>% 
  mutate(Dispense_YrQtr = as.yearqtr(
    paste(Dispense_Year, Dispense_Qtr, sep = " Q"), "%Y Q%q")
  )

dispense_chronic_qtr <- dispense_chronic %>% 
  group_by(ChronicIllness, Dispense_Year, Dispense_Qtr) %>% 
  summarise(trans_count = sum(n, na.rm = TRUE)) %>% 
  mutate(Dispense_YrQtr = as.yearqtr(
    paste(Dispense_Year, Dispense_Qtr, sep = " Q"), "%Y Q%q")
  )


dispense_chronic_qtr <- dispense_chronic %>% 
  group_by(ChronicIllness, Dispense_Year, Dispense_Qtr) %>% 
  summarise(trans_count = sum(n, na.rm = TRUE)) %>% 
  mutate(Dispense_YrQtr = as.yearqtr(
    paste(Dispense_Year, Dispense_Qtr, sep = " Q"), "%Y Q%q")
  )

```
background-image: url(transparent_merops_small.png)
background-position: center top
class: left
# Outline

- Temporal trends in drug sales
- Spatial distribution
- How gender, age, and disease are related to sales
- Data processing
- Weird findings

---

background-image: url(transparent_merops_small.png)
background-position: center top
class: left
# Drug sales over time increasing

```{r fig.width=10, fig.height=6}

dispense %>% 
  group_by(Dispense_Week) %>% 
  summarise(trans_count = sum(n, na.rm = TRUE)) %>% 
  ggplot(aes(x = Dispense_Week, y = trans_count)) +
  geom_line() +
  geom_point() -> p1

dispense_qtr %>% 
  ggplot(aes(x = Dispense_YrQtr, y = trans_count)) +
  geom_line() +
  geom_point() +
  scale_x_yearqtr(format = "%Y Q%q", n = 5) -> p2

dispense_chronic_qtr %>% 
  ggplot(aes(x = Dispense_YrQtr, y = trans_count)) +
  geom_line() +
  geom_point() +
  facet_grid(ChronicIllness ~ ., scales = "free_y") +
  scale_x_yearqtr(format = "%Y Q%q", n = 5) -> p3

grid.arrange(p1, p2, p3, ncol=2, layout_matrix=rbind(c(1, 3), c(2, 3)))
```

and seasonal, except for osteoporosis.
---

background-image: url(transparent_merops_small.png)
background-position: center top
class: left
# One patient who spent `$25000` lives on 

```{r fig.width=4, fig.height=4, fig.align='center'}
load("data/patient_524988.rda")
pt_524998 <- pt_524998 %>% 
  mutate(Dispense_Week = ymd(Dispense_Week), 
  Prescription_Week = ymd(Prescription_Week))
#ggplot(data=pt_524998, 
#       aes(x=Prescription_Week, y=Dispensed_Qty, colour=Drug_Code)) + geom_point()
#map <- read_csv("nat_map_pop.csv")
#tassie <- map %>% filter(substr(POA_CODE, 1, 1) == "7")
#ggplot(data=tassie, aes(x=long, y=lat, group=group)) +
#  geom_path() + theme_map()
centroids <- read_csv("postcode_centroids.csv")
postcodes <- c(unique(pt_524998$postcode_patient),
              unique(pt_524998$postcode))
centroids %>% filter(POA_CODE %in% postcodes) %>%
  select(long_c, lat_c) %>%
  mutate(label = c("patient", "store")) -> loc

m <- get_map(location = "Tasmania", zoom=7, scale=1) 
ggmap(m) +
  geom_point(data=loc, aes(x=long_c, y=lat_c)) +
  geom_text(data=loc, 
            aes(x=long_c, y=lat_c, label=label), 
            hjust = 1, nudge_x = 0.05,
            vjust = 0, nudge_y = 0.1) +
  theme_map()

#pt_524998_drugs <- pt_524998 %>% 
#  select(Drug_ID, Drug_Code) %>% distinct()
#illness %>% filter(MasterProductID %in% #pt_524998_drugs$Drug_ID) %>% 
#  select(ChronicIllness) %>% distinct()
```

Flinders Island and buys their drugs on mainland Tasmania. Treatment was for Epilepsy and Depression.
---
-Map out locations big spenders
-Reasons for spending

---
background-image: url(transparent_merops_small.png)
background-position: center top
class: left
# Market share

Apotex sold 60 of 80 scripts in ... typical market share

---

background-image: url(transparent_merops_small.png)
background-position: center top
class: left
# Acknowledgements

Slides created via the R package [**xaringan**](https://github.com/yihui/xaringan).

The chakra comes from [remark.js](https://remarkjs.com), [**knitr**](http://yihui.name/knitr), and [R Markdown](https://rmarkdown.rstudio.com).

Rainbow bee-eater (merops ornatus) photo by JJ Harrison, CC license
